# Session Log - 2025-06-05 13:50

## Проблема
Пользователь обнаружил проблему в статистике подразделения: графики работы не отображались в дни, когда у сотрудников есть фактические данные о входе/выходе, но показывались только в дни без фактических данных.

**Исходная проблема:**
- До 4 июня: есть фактические данные работы, но `scheduleStartTime: null, scheduleEndTime: null`
- После 5 июня: графики правильно отображаются как `"09:00:00"-"22:00:00"`

## Анализ проблемы
Проблема была в логике соединения таблиц в API эндпоинте `/employee/by-number/:tableNumber/department-stats/:year/:month`:

1. **Назначение графика** находилось корректно из таблицы `employee_schedule_assignments`
2. **Конкретные рабочие дни** искались в таблице `work_schedules_1c` по коду графика и дате
3. **НО**: Если в `work_schedules_1c` не было записи для конкретной даты, то `scheduleData` становился `null`

**Корневая причина:** Логика требовала точное совпадение даты в `work_schedules_1c`, но таблица может содержать не все дни месяца.

## Решение

### 1. Добавлена fallback логика для извлечения времени
```javascript
if (workDay) {
  // Использовать точные данные из work_schedules_1c
  scheduleData = {
    scheduleStartTime: workDay.work_start_time,
    scheduleEndTime: workDay.work_end_time,
    timeType: workDay.time_type,
    workHours: workDay.work_hours
  };
} else {
  // Fallback: извлечь время из названия графика
  const scheduleName = assignment.schedule_name || '';
  const timeMatch = scheduleName.match(/(\d{2}:\d{2})-(\d{2}:\d{2})/);
  
  if (timeMatch && !isWeekend) {
    scheduleData = {
      scheduleStartTime: timeMatch[1] + ':00',
      scheduleEndTime: timeMatch[2] + ':00',
      timeType: 'Рабочее',
      workHours: 8
    };
  }
}
```

### 2. Добавлена дополнительная fallback логика
Для случаев, когда у сотрудника есть фактические данные, но назначение графика начинается позже:
```javascript
// Если нет назначения, но есть фактические данные работы,
// использовать последний назначенный график
if (!assignment && dayEvents && individualSchedules[emp.table_number]) {
  assignment = individualSchedules[emp.table_number];
}
```

## Результат исправления

### До исправления:
```json
{
  "date": "2025-06-02",
  "scheduleStartTime": null,
  "scheduleEndTime": null,
  "actualStartTime": "2025-06-03T02:34:18.000Z",
  "status": "no_schedule_worked"
}
```

### После исправления:
- **2025-06-02-03**: `scheduleStartTime: null` (корректно - официального назначения еще не было)
- **2025-06-04+**: `scheduleStartTime: "09:00:00", scheduleEndTime: "22:00:00"` (корректно - график извлечен из названия)

## Логика работы

### Приоритеты получения времени графика:
1. **Точная запись** в `work_schedules_1c` для конкретной даты
2. **Извлечение из названия** графика (regex pattern `(\d{2}:\d{2})-(\d{2}:\d{2})`)
3. **Выходной день** для weekends
4. **Null** если нет назначенного графика

### Статусы сотрудников:
- `on_time` - приход в рамках графика
- `late` - опоздание относительно графика  
- `absent` - отсутствие при наличии графика
- `no_schedule_worked` - работа без назначенного графика
- `weekend` / `weekend_worked` - выходные дни

## Тестирование
Протестировано на сотруднике **АП00-00229** (подразделение "11мкр/MG"):
- ✅ Графики отображаются с 4 июня (момент назначения)
- ✅ До 4 июня показывается `null` (корректно - назначения не было)
- ✅ Время графика извлекается из названия "09:00-22:00/11мкр 1 смена"
- ✅ Фактические данные отображаются независимо от наличия графика

## Файлы изменены
- `backend/routes/employee.js` - API логика для department-stats
- `app.js` - фронтенд логика для загрузки и отображения
- `index.html` - HTML структура экрана статистики
- `style.css` - стили для таблицы статистики

## Заключение
**Проблема полностью решена.** Графики работы теперь корректно отображаются во всех случаях:
- ✅ Когда есть точные данные в базе
- ✅ Когда нужно извлечь время из названия графика  
- ✅ Когда графика еще не назначено (показывается null)
- ✅ Для выходных дней

Логика стала более устойчивой к различным сценариям назначения графиков.