<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>üöÄ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Telegram Mini App</h1>
    
    <div class="test-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
        <button onclick="testServers()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã</button>
        <div id="server-status"></div>
    </div>

    <div class="test-section">
        <h3>2. –¢–µ—Å—Ç API –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
        <button onclick="testLogin()">–¢–µ—Å—Ç –≤—Ö–æ–¥–∞ (–ê–ü00-00358)</button>
        <button onclick="testAdminLogin()">–¢–µ—Å—Ç –∞–¥–º–∏–Ω –≤—Ö–æ–¥–∞</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Telegram WebApp SDK</h3>
        <button onclick="testTelegramSDK()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SDK</button>
        <div id="telegram-result"></div>
    </div>

    <div class="test-section">
        <h3>4. –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ UI</h3>
        <button onclick="testNavigation()">–¢–µ—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏</button>
        <a href="/" target="_blank">
            <button>–û—Ç–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
        </a>
        <div id="navigation-result"></div>
    </div>

    <div class="test-section">
        <h3>5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h3>
        <div id="test-summary"></div>
    </div>

    <script>
        let testResults = {
            servers: false,
            login: false,
            telegram: false,
            navigation: false
        };

        async function testServers() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.innerHTML = '<div class="info">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä—ã...</div>';
            
            let results = [];
            
            try {
                // Test backend
                const backendResponse = await fetch('http://localhost:3030/api/health');
                if (backendResponse.ok) {
                    results.push('<div class="success">‚úÖ Backend (–ø–æ—Ä—Ç 3030): OK</div>');
                    testResults.servers = true;
                } else {
                    results.push('<div class="error">‚ùå Backend: –û—à–∏–±–∫–∞ ' + backendResponse.status + '</div>');
                }
            } catch (error) {
                results.push('<div class="error">‚ùå Backend: ' + error.message + '</div>');
            }
            
            try {
                // Test frontend
                const frontendResponse = await fetch('http://localhost:5555/index.html');
                if (frontendResponse.ok) {
                    results.push('<div class="success">‚úÖ Frontend (–ø–æ—Ä—Ç 5555): OK</div>');
                } else {
                    results.push('<div class="error">‚ùå Frontend: –û—à–∏–±–∫–∞ ' + frontendResponse.status + '</div>');
                }
            } catch (error) {
                results.push('<div class="error">‚ùå Frontend: ' + error.message + '</div>');
            }
            
            statusDiv.innerHTML = results.join('');
            updateSummary();
        }

        async function testLogin() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '<div class="info">–¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...</div>';
            
            try {
                // Test regular login
                const response = await fetch('http://localhost:3030/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableNumber: '–ê–ü00-00358' })
                });
                
                if (response.ok) {
                    const employee = await response.json();
                    
                    // Test Telegram linking
                    const linkResponse = await fetch('http://localhost:3030/api/telegram/link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: 'dev_mode', employeeNumber: '–ê–ü00-00358' })
                    });
                    
                    let telegramResult = '';
                    if (linkResponse.ok) {
                        const linkData = await linkResponse.json();
                        telegramResult = '<div class="success">‚úÖ Telegram –ø—Ä–∏–≤—è–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>';
                        
                        // Test Telegram auth
                        const authResponse = await fetch('http://localhost:3030/api/telegram/auth', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ initData: 'dev_mode' })
                        });
                        
                        if (authResponse.ok) {
                            const authData = await authResponse.json();
                            telegramResult += '<div class="success">‚úÖ Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç</div>';
                        }
                    } else {
                        telegramResult = '<div class="error">‚ùå –û—à–∏–±–∫–∞ Telegram –ø—Ä–∏–≤—è–∑–∫–∏</div>';
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ –û–±—ã—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞</div>
                        <div class="result">
                            <strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> ${employee.fullName}<br>
                            <strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ${employee.department}<br>
                            <strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> ${employee.position}
                        </div>
                        ${telegramResult}
                    `;
                    testResults.login = true;
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</div>`;
            }
            
            updateSummary();
        }

        async function testAdminLogin() {
            const resultDiv = document.getElementById('login-result');
            
            try {
                const response = await fetch('http://localhost:3030/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableNumber: 'admin12qw' })
                });
                
                if (response.ok) {
                    const admin = await response.json();
                    resultDiv.innerHTML += `
                        <div class="success">‚úÖ –ê–¥–º–∏–Ω –≤—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
                        <div class="result">
                            <strong>–ê–¥–º–∏–Ω:</strong> ${admin.fullName}<br>
                            <strong>isAdmin:</strong> ${admin.isAdmin}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∞–¥–º–∏–Ω –≤—Ö–æ–¥–∞: ${error.message}</div>`;
            }
        }

        function testTelegramSDK() {
            const resultDiv = document.getElementById('telegram-result');
            
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Telegram WebApp SDK –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    <div class="result">
                        <strong>Platform:</strong> ${window.Telegram.WebApp.platform}<br>
                        <strong>Version:</strong> ${window.Telegram.WebApp.version}<br>
                        <strong>In Telegram:</strong> ${window.Telegram.WebApp.initData ? '–î–∞' : '–ù–µ—Ç (—ç–º—É–ª—è—Ü–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ)'}
                    </div>
                `;
                testResults.telegram = true;
            } else {
                resultDiv.innerHTML = '<div class="error">‚ùå Telegram WebApp SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
            }
            
            updateSummary();
        }

        function testNavigation() {
            const resultDiv = document.getElementById('navigation-result');
            
            if (typeof showScreen === 'function') {
                resultDiv.innerHTML = '<div class="success">‚úÖ –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>';
                testResults.navigation = true;
            } else {
                resultDiv.innerHTML = '<div class="error">‚ùå –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
            
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('test-summary');
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            
            let status = 'info';
            if (passed === total) status = 'success';
            else if (passed === 0) status = 'error';
            
            summaryDiv.innerHTML = `
                <div class="${status}">
                    <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤: ${passed}/${total} –ø—Ä–æ–π–¥–µ–Ω–æ</strong><br>
                    ${passed === total ? 'üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!' : 
                      passed > 0 ? '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å' : '‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞'}
                </div>
            `;
        }

        // Auto-run basic tests
        window.addEventListener('load', () => {
            testTelegramSDK();
            testNavigation();
        });
    </script>
</body>
</html>